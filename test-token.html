<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Token - Makawi Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="Css/estilos.css" rel="stylesheet">
    <link href="Css/Componentes/toast.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Prueba de Validación de Token</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h4>Estado del Token</h4>
                            <div id="token-status" class="alert alert-info">
                                Verificando estado del token...
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h4>Información del Token</h4>
                            <div id="token-info" class="border p-3 rounded bg-light">
                                <p>Cargando información...</p>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button id="check-token" class="btn btn-primary">
                                <i class="bi bi-shield-check me-2"></i>Verificar Token
                            </button>
                            <button id="renew-token" class="btn btn-success">
                                <i class="bi bi-arrow-repeat me-2"></i>Renovar Token
                            </button>
                            <button id="expire-token" class="btn btn-danger">
                                <i class="bi bi-x-circle me-2"></i>Simular Expiración
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="Js/toast.js"></script>
    <script src="Js/token-validator.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tokenStatus = document.getElementById('token-status');
            const tokenInfo = document.getElementById('token-info');
            const checkTokenBtn = document.getElementById('check-token');
            const renewTokenBtn = document.getElementById('renew-token');
            const expireTokenBtn = document.getElementById('expire-token');
            
            // Función para actualizar la información del token
            function updateTokenInfo() {
                const token = localStorage.getItem('token');
                
                if (!token) {
                    tokenStatus.className = 'alert alert-warning';
                    tokenStatus.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>No hay token almacenado';
                    tokenInfo.innerHTML = '<p>No hay información disponible</p>';
                    return;
                }
                
                try {
                    // Usar la función de decodificarToken del archivo token-validator.js
                    const payload = decodificarToken(token);
                    
                    if (!payload) {
                        tokenStatus.className = 'alert alert-danger';
                        tokenStatus.innerHTML = '<i class="bi bi-x-circle me-2"></i>Token inválido';
                        tokenInfo.innerHTML = '<p>No se pudo decodificar el token</p>';
                        return;
                    }
                    
                    // Verificar si el token ha expirado
                    const expirado = verificarTokenExpirado();
                    const porExpirar = tokenPorExpirar();
                    
                    if (expirado) {
                        tokenStatus.className = 'alert alert-danger';
                        tokenStatus.innerHTML = '<i class="bi bi-x-circle me-2"></i>Token expirado';
                    } else if (porExpirar) {
                        tokenStatus.className = 'alert alert-warning';
                        tokenStatus.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Token por expirar pronto';
                    } else {
                        tokenStatus.className = 'alert alert-success';
                        tokenStatus.innerHTML = '<i class="bi bi-check-circle me-2"></i>Token válido';
                    }
                    
                    // Mostrar información del token
                    const fechaExp = new Date(payload.exp * 1000);
                    const ahora = new Date();
                    const minutosRestantes = Math.round((fechaExp - ahora) / (1000 * 60));
                    
                    tokenInfo.innerHTML = `
                        <p><strong>Usuario ID:</strong> ${payload.id}</p>
                        <p><strong>Nombre:</strong> ${payload.nombre}</p>
                        <p><strong>Rol:</strong> ${payload.rol}</p>
                        <p><strong>Expira:</strong> ${fechaExp.toLocaleString()}</p>
                        <p><strong>Tiempo restante:</strong> ${minutosRestantes} minutos</p>
                    `;
                } catch (error) {
                    console.error('Error al procesar token:', error);
                    tokenStatus.className = 'alert alert-danger';
                    tokenStatus.innerHTML = '<i class="bi bi-x-circle me-2"></i>Error al procesar token';
                    tokenInfo.innerHTML = `<p>Error: ${error.message}</p>`;
                }
            }
            
            // Verificar token al cargar la página
            updateTokenInfo();
            
            // Botón para verificar token
            checkTokenBtn.addEventListener('click', () => {
                updateTokenInfo();
                mostrarToast('Información del token actualizada', 'success');
            });
            
            // Botón para renovar token
            renewTokenBtn.addEventListener('click', async () => {
                try {
                    const renovado = await renovarToken();
                    if (renovado) {
                        mostrarToast('Token renovado exitosamente', 'success');
                    } else {
                        mostrarToast('No se pudo renovar el token', 'error');
                    }
                    updateTokenInfo();
                } catch (error) {
                    console.error('Error al renovar token:', error);
                    mostrarToast(`Error: ${error.message}`, 'error');
                }
            });
            
            // Botón para simular expiración
            expireTokenBtn.addEventListener('click', () => {
                const token = localStorage.getItem('token');
                if (!token) {
                    mostrarToast('No hay token para simular expiración', 'warning');
                    return;
                }
                
                try {
                    // Decodificar el token actual
                    const payload = decodificarToken(token);
                    if (!payload) {
                        mostrarToast('No se pudo decodificar el token', 'error');
                        return;
                    }
                    
                    // Simular expiración forzando el cierre de sesión
                    // en lugar de modificar el token
                    mostrarToast('Simulando token expirado...', 'warning');
                    setTimeout(() => {
                        cerrarSesion();
                    }, 1000);
                } catch (error) {
                    console.error('Error al simular expiración:', error);
                    mostrarToast(`Error: ${error.message}`, 'error');
                }
            });
        });
    </script>
</body>
</html>